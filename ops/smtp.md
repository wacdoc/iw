# בנה שרת שליחת דואר SMTP משלך

## הַקדָמָה

SMTP יכול לרכוש שירותים ישירות מספקי ענן, כגון:

* [אמזון SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [דחיפה של אלי ענן מייל](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

אתה יכול גם לבנות שרת דואר משלך - שליחה ללא הגבלה, עלות כוללת נמוכה.

להלן, אנו מדגים צעד אחר צעד כיצד לבנות שרת דואר משלנו.

## בחירת שרת

שרת ה-SMTP המתארח בעצמו דורש IP ציבורי עם יציאות 25, 456 ו-587 פתוחות.

עננים ציבוריים נפוצים חסמו את היציאות הללו כברירת מחדל, וייתכן שניתן יהיה לפתוח אותם על ידי הוצאת הזמנת עבודה, אבל זה מאוד בעייתי אחרי הכל.

אני ממליץ לקנות מארח שיש לו יציאות פתוחות ותומך בהגדרת שמות דומיין הפוכים.

כאן, אני ממליץ על [Contabo](https://contabo.com) .

Contabo היא ספקית אירוח שבסיסה במינכן, גרמניה, נוסדה בשנת 2003 עם מחירים תחרותיים מאוד.

אם תבחרו ביורו כמטבע הרכישה, המחיר יהיה זול יותר (שרת עם זיכרון של 8GB ו-4 מעבדים עולה כ-529 יואן לשנה, ודמי ההתקנה הראשוניים בחינם לשנה).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

בעת ביצוע הזמנה, הערה `prefer AMD` , והשרת עם AMD CPU יהיו בעלי ביצועים טובים יותר.

בהמשך, אקח את ה-VPS של Contabo כדוגמה כדי להדגים כיצד לבנות שרת דואר משלך.

## תצורת מערכת אובונטו

מערכת ההפעלה כאן היא אובונטו 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

אם השרת ב-ssh מציג `Welcome to TinyCore 13!` (כפי שמוצג באיור למטה), זה אומר שהמערכת עדיין לא הותקנה. נא לנתק את ssh ולהמתין מספר דקות כדי להתחבר שוב.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

כאשר מופיע `Welcome to Ubuntu 22.04.1 LTS` , האתחול הושלם, ותוכל להמשיך עם השלבים הבאים.

### [אופציונלי] אתחול סביבת הפיתוח

שלב זה הוא אופציונלי.

מטעמי נוחות, שמתי את ההתקנה ותצורת המערכת של תוכנת ubuntu ב- [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) .

הפעל את הפקודה הבאה להתקנה בלחיצה אחת.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

משתמשים סיניים, אנא השתמשו בפקודה הבאה במקום זאת, והשפה, אזור הזמן וכו' יוגדרו אוטומטית.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo מאפשר IPV6

הפעל את IPV6 כך ש-SMTP יוכל לשלוח גם מיילים עם כתובות IPV6.

ערוך את `/etc/sysctl.conf`

שנה או הוסף את השורות הבאות

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

המשך עם [מדריך הקונטאבו: הוספת קישוריות IPv6 לשרת שלך](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

ערוך את `/etc/netplan/01-netcfg.yaml` , הוסף כמה שורות כפי שמוצג באיור למטה (בקובץ תצורת ברירת המחדל של Contabo VPS כבר יש את השורות האלה, פשוט בטל את ההערה).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

לאחר מכן, `netplan apply` להפעיל את התצורה ששונתה.

לאחר שההגדרה תצליח, תוכל להשתמש `curl 6.ipw.cn` כדי להציג את כתובת ה-ipv6 של הרשת החיצונית שלך.

## שכבו את אופציות מאגר התצורה

```
git clone https://github.com/wactax/ops.soft.git
```

## הפק אישור SSL בחינם עבור שם הדומיין שלך

שליחת דואר דורשת אישור SSL להצפנה וחתימה.

אנו משתמשים [ב-acme.sh](https://github.com/acmesh-official/acme.sh) כדי ליצור אישורים.

acme.sh הוא כלי חתימה אוטומטית של אישורים בקוד פתוח,

היכנס למחסן התצורה ops.soft, הפעל `./ssl.sh` , ותיווצר תיקיית `conf` **בספרייה העליונה** .

מצא את ספק ה-DNS שלך מ- [acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) , ערוך `conf/conf.sh` .

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

לאחר מכן הפעל `./ssl.sh 123.com` כדי ליצור אישורי `123.com` ו `*.123.com` עבור שם הדומיין שלך.

ההרצה הראשונה תתקין [את acme.sh](https://github.com/acmesh-official/acme.sh) באופן אוטומטי ותוסיף משימה מתוזמנת לחידוש אוטומטי. אתה יכול לראות `crontab -l` , יש שורה כזו כדלקמן.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

הנתיב לאישור שנוצר הוא משהו כמו `/mnt/www/.acme.sh/123.com_ecc。`

חידוש האישור יקרא סקריפט `conf/reload/123.com.sh` , ערוך סקריפט זה, אתה יכול להוסיף פקודות כגון `nginx -s reload` כדי לרענן את מטמון האישורים של יישומים קשורים.

## בניית שרת SMTP עם chasquid

[chasquid](https://github.com/albertito/chasquid) הוא שרת SMTP בקוד פתוח שנכתב בשפת Go.

כתחליף לתוכניות שרת הדואר העתיקות כמו Postfix ו-Sendmail, Chasquid פשוט וקל יותר לשימוש, וגם קל יותר לפיתוח משני.

הפעל `./chasquid/init.sh 123.com` יותקן אוטומטית בלחיצה אחת (החלף את 123.com בשם הדומיין השולח שלך).

## הגדר את חתימת הדוא"ל DKIM

DKIM משמש לשליחת חתימות דואר אלקטרוני כדי למנוע התייחסות למכתבים כדואר זבל.

לאחר שהפקודה פועלת בהצלחה, תתבקש להגדיר את רשומת DKIM (כפי שמוצג להלן).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

פשוט הוסף רשומת TXT ל-DNS שלך (כפי שמוצג להלן).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## הצג את סטטוס השירות והיומנים

 `systemctl status chasquid` הצג את מצב השירות.

מצב הפעולה הרגיל הוא כפי שמוצג באיור למטה

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` או `journalctl -xeu chasquid` יכולים להציג את יומן השגיאות.

## הפוך את תצורת שם הדומיין

שם התחום ההפוך נועד לאפשר פתרון כתובת ה-IP לשם התחום המתאים.

הגדרת שם דומיין הפוך יכולה למנוע אימיילים להיות מזוהים כספאם.

כאשר הדואר מתקבל, השרת המקבל יבצע ניתוח שם דומיין הפוך על כתובת ה-IP של השרת השולח כדי לאשר האם לשרת השולח יש שם דומיין הפוך חוקי.

אם לשרת השולח אין שם דומיין הפוך או אם שם הדומיין ההפוך אינו תואם לכתובת ה-IP של השרת השולח, השרת המקבל עשוי לזהות את האימייל כדואר זבל או לדחות אותו.

בקר בכתובת [https://my.contabo.com/rdns](https://my.contabo.com/rdns) והגדר כפי שמוצג להלן

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

לאחר הגדרת שם הדומיין ההפוך, זכור להגדיר את הרזולוציה קדימה של שם הדומיין ipv4 ו-ipv6 לשרת.

## ערוך את שם המארח של chasquid.conf

שנה `conf/chasquid/chasquid.conf` לערך של שם הדומיין ההפוך.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

לאחר מכן הפעל את `systemctl restart chasquid` כדי להפעיל מחדש את השירות.

## גיבוי conf למאגר git

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

לדוגמה, אני מגבה את תיקיית ה-conf לתהליך ה-github שלי באופן הבא

תחילה צור מחסן פרטי

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

היכנס לספריית ה-conf ושלח למחסן

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## הוסף שולח

לָרוּץ

```
chasquid-util user-add i@wac.tax
```

יכול להוסיף שולח

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### ודא שהסיסמה מוגדרת כהלכה

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

לאחר הוספת המשתמש, `chasquid/domains/wac.tax/users` יתעדכנו, זכרו להגיש למחסן.

## DNS הוסף רשומת SPF

SPF (Sender Policy Framework) היא טכנולוגיית אימות דוא"ל המשמשת למניעת הונאת דוא"ל.

הוא מאמת את זהותו של שולח דואר על ידי בדיקה שכתובת ה-IP של השולח תואמת לרשומות ה-DNS של שם הדומיין שהוא טוען להיות, ומונעת מהרמאים לשלוח מיילים מזויפים.

הוספת רשומות SPF יכולה למנוע זיהוי דואר אלקטרוני ככל האפשר כספאם.

אם שרת שמות הדומיין שלך אינו תומך בסוג SPF, פשוט הוסף רשומת מסוג TXT.

לדוגמה, ה-SPF של `wac.tax` הוא כדלקמן

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF עבור `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

שים לב שיש לי `include:_spf.google.com` כאן, הסיבה לכך היא שאגדיר `i@wac.tax` ככתובת השליחה בתיבת הדואר של Google מאוחר יותר.

## תצורת DNS DMARC

DMARC הוא הקיצור של (אימות הודעות מבוסס דומיין, דיווח והתאמה).

הוא משמש כדי ללכוד הקפצות SPF (אולי נגרמות משגיאות תצורה, או שמישהו אחר מעמיד פנים שהוא אתה כדי לשלוח דואר זבל).

הוסף רשומת TXT `_dmarc` ,

התוכן הוא כדלקמן

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

המשמעות של כל פרמטר היא כדלקמן

### p (מדיניות)

מציין כיצד לטפל באימיילים שנכשלים באימות SPF (Sender Policy Framework) או DKIM (DomainKeys Identified Mail). ניתן להגדיר את הפרמטר p לאחד משלושה ערכים:

* אין: לא ננקטת כל פעולה, רק תוצאת האימות מוזנת לשולח באמצעות מנגנון הדיווח בדוא"ל.
* הסגר: הכנס את הדואר שלא עבר את האימות לתיקיית הספאם, אך לא ידחה את הדואר ישירות.
* דחה: דחה ישירות הודעות דוא"ל שנכשלות באימות.

### fo (אפשרויות כישלון)

מציין את כמות המידע המוחזר על ידי מנגנון הדיווח. ניתן להגדיר אותו לאחד מהערכים הבאים:

* 0: דווח על תוצאות אימות עבור כל ההודעות
* 1: דווח רק על הודעות שנכשלות באימות
* ד: דווח רק על כשלים באימות שם הדומיין
* s: דווח רק על כשלי אימות SPF
* l: דווח רק על כשלי אימות DKIM

### rua & ruf

* rua (URI לדיווח עבור דוחות מצטברים): כתובת דואר אלקטרוני לקבלת דוחות מצטברים
* ruf (Reporting URI for Forensic reports): כתובת דואר אלקטרוני לקבלת דוחות מפורטים

## הוסף רשומות MX כדי להעביר אימיילים ל-Google Mail

מכיוון שלא הצלחתי למצוא תיבת דואר ארגונית חינמית שתומכת בכתובות אוניברסליות (Catch-All, יכולה לקבל כל מייל שנשלח לשם התחום הזה, ללא הגבלות על קידומות), השתמשתי בצ'אקוויד כדי להעביר את כל המיילים לתיבת הדואר שלי ב-Gmail.

**אם יש לך תיבת דואר עסקית משלך בתשלום, נא לא לשנות את ה-MX ולדלג על שלב זה.**

ערוך `conf/chasquid/domains/wac.tax/aliases` , הגדר תיבת דואר להעברה

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` מציין את כל המיילים, `i` היא קידומת כתובת האימייל של המשתמש השולח שנוצר לעיל. כדי להעביר דואר, כל משתמש צריך להוסיף שורה.

לאחר מכן הוסף את רשומת ה-MX (אני מצביע ישירות על הכתובת של שם הדומיין ההפוך כאן, כפי שמוצג בשורה הראשונה באיור למטה).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

לאחר השלמת התצורה, תוכל להשתמש בכתובות דוא"ל אחרות כדי לשלוח דוא"ל אל `i@wac.tax` ו- `any123@wac.tax` כדי לראות אם אתה יכול לקבל אימיילים ב-Gmail.

אם לא, בדוק את יומן ה-chasquid ( `grep chasquid /var/log/syslog` ).

## שלח אימייל אל i@wac.tax עם Google Mail

לאחר ש-Google Mail קיבל את הדואר, קיוויתי כמובן להשיב ב- `i@wac.tax` במקום i.wac.tax@gmail.com.

בקר בכתובת [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) ולחץ על "הוסף כתובת אימייל נוספת".

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

לאחר מכן, הזן את קוד האימות שהתקבל בדוא"ל שאליו הועבר.

לבסוף, ניתן להגדיר אותה ככתובת השולח המוגדרת כברירת מחדל (יחד עם האפשרות להשיב עם אותה כתובת).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

בדרך זו, השלמנו את הקמת שרת הדואר SMTP ובמקביל משתמשים ב-Google Mail לשליחת ולקבלת מיילים.

## שלח הודעת דוא"ל לבדיקה כדי לבדוק אם התצורה הצליחה

הזן `ops/chasquid`

הפעל את `direnv allow` להתקין תלות (direnv הותקן בתהליך האתחול הקודם של מפתח אחד והוק התווסף למעטפת)

ואז לרוץ

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

המשמעות של הפרמטרים היא כדלקמן

* משתמש: שם משתמש SMTP
* pass: סיסמת SMTP
* אל: נמען

אתה יכול לשלוח מייל לבדיקה.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

מומלץ להשתמש ב-Gmail כדי לקבל מיילים לבדיקה כדי לבדוק אם ההגדרות מוצלחות.

### הצפנה סטנדרטית TLS

כפי שמוצג באיור למטה, יש את המנעול הקטן הזה, מה שאומר שאישור ה-SSL הופעלה בהצלחה.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

לאחר מכן לחץ על "הצג אימייל מקורי"

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

כפי שמוצג באיור למטה, דף הדואר המקורי של Gmail מציג DKIM, מה שאומר שתצורת ה-DKIM הצליחה.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

סמן את ה-Received בכותרת של האימייל המקורי, ותוכל לראות שכתובת השולח היא IPV6, מה שאומר שגם IPV6 הוגדר בהצלחה.
